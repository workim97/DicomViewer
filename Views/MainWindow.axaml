<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:DicomViewer.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
        x:Class="DicomViewer.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="DicomViewer"
        Width="1200" Height="800">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- 상단 도구모음 -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10" Spacing="5">
            <Button Content="파일 열기" Command="{Binding OpenFileCommand}" Padding="10,5"/>
            <Button Content="시리즈 열기" Command="{Binding OpenSeriesCommand}" Padding="10,5"/>
            <Separator Width="1" Margin="5,0"/>
            <Button Content="확대" Command="{Binding ZoomInCommand}" Padding="10,5"/>
            <Button Content="축소" Command="{Binding ZoomOutCommand}" Padding="10,5"/>
            <Button Content="원본크기" Command="{Binding ResetViewCommand}" Padding="10,5"/>
            <Button Content="창에맞춤" Command="{Binding FitToWindowCommand}" Padding="10,5"/>
            <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center" Margin="20,0,0,0" Foreground="Gray"/>
        </StackPanel>

        <!-- 메인 콘텐츠 영역 -->
        <Grid Grid.Row="1" ColumnDefinitions="250,*">
            <!-- 왼쪽 패널: 환자/검사 정보 -->
            <Border Grid.Column="0" BorderBrush="LightGray" BorderThickness="0,0,1,0" Padding="10">
                <ScrollViewer>
                    <StackPanel Spacing="5">
                        <!-- 환자 정보 -->
                        <TextBlock Text="환자 정보" FontWeight="Bold" FontSize="16"/>
                        <Separator Margin="0,5"/>

                        <StackPanel Spacing="3">
                            <TextBlock Text="이름:" FontSize="12" Foreground="Gray"/>
                            <TextBlock Text="{Binding CurrentPatient.PatientName}" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,8"/>

                            <TextBlock Text="ID:" FontSize="12" Foreground="Gray"/>
                            <TextBlock Text="{Binding CurrentPatient.PatientID}" FontSize="14" Margin="0,0,0,8"/>

                            <TextBlock Text="생년월일:" FontSize="12" Foreground="Gray"/>
                            <TextBlock Text="{Binding CurrentPatient.BirthDate}" FontSize="14" Margin="0,0,0,8"/>

                            <TextBlock Text="성별:" FontSize="12" Foreground="Gray"/>
                            <TextBlock Text="{Binding CurrentPatient.Sex}" FontSize="14" Margin="0,0,0,8"/>
                        </StackPanel>

                        <!-- 검사 정보 -->
                        <TextBlock Text="검사 정보" FontWeight="Bold" FontSize="16" Margin="0,15,0,0"/>
                        <Separator Margin="0,5"/>

                        <StackPanel Spacing="3">
                            <TextBlock Text="검사일:" FontSize="12" Foreground="Gray"/>
                            <TextBlock Text="{Binding CurrentStudy.StudyDate}" FontSize="14" Margin="0,0,0,8"/>

                            <TextBlock Text="모달리티:" FontSize="12" Foreground="Gray"/>
                            <TextBlock Text="{Binding CurrentStudy.Modality}" FontSize="14" Margin="0,0,0,8"/>

                            <TextBlock Text="기관:" FontSize="12" Foreground="Gray"/>
                            <TextBlock Text="{Binding CurrentStudy.InstitutionName}" FontSize="14" Margin="0,0,0,8"/>
                        </StackPanel>

                        <!-- Window/Level 컨트롤 -->
                        <TextBlock Text="Window/Level" FontWeight="Bold" FontSize="16" Margin="0,15,0,0"/>
                        <Separator Margin="0,5"/>

                        <StackPanel Spacing="3">
                            <TextBlock Text="{Binding WindowCenter, StringFormat='Window: {0:F0}'}" FontSize="14"/>
                            <Slider Value="{Binding WindowCenter}"
                                    Minimum="-1024" Maximum="3000"
                                    Margin="0,5"/>

                            <TextBlock Text="{Binding WindowLevel, StringFormat='Level: {0:F0}'}" FontSize="14" Margin="0,10,0,0"/>
                            <Slider Value="{Binding WindowLevel}"
                                    Minimum="1" Maximum="4000"
                                    Margin="0,5"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- 오른쪽 패널: 이미지 뷰어 -->
            <Grid Grid.Column="1" RowDefinitions="*,Auto">
                <!-- 이미지 표시 영역 -->
                <Border Grid.Row="0" Background="Black" ClipToBounds="True">
                    <Image x:Name="DicomImage"
                           Source="{Binding CurrentImage}"
                           Stretch="None"
                           RenderTransformOrigin="0.5,0.5">
                        <Image.RenderTransform>
                            <MatrixTransform Matrix="{Binding ImageTransform}"/>
                        </Image.RenderTransform>
                    </Image>
                </Border>

                <!-- 하단 W/L 컨트롤 및 슬라이스 정보 -->
                <StackPanel Grid.Row="1" Orientation="Horizontal"
                            HorizontalAlignment="Center"
                            Margin="10"
                            Spacing="15">
                    <TextBlock Text="Window:" VerticalAlignment="Center" FontWeight="SemiBold"/>
                    <Slider Width="200"
                            Value="{Binding WindowCenter}"
                            Minimum="-1024" Maximum="3000"
                            VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding WindowCenter, StringFormat='{}{0:F0}'}"
                               Width="60"
                               VerticalAlignment="Center"
                               TextAlignment="Right"/>

                    <Separator Width="1" Height="25"/>

                    <TextBlock Text="Level:" VerticalAlignment="Center" FontWeight="SemiBold"/>
                    <Slider Width="200"
                            Value="{Binding WindowLevel}"
                            Minimum="1" Maximum="4000"
                            VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding WindowLevel, StringFormat='{}{0:F0}'}"
                               Width="60"
                               VerticalAlignment="Center"
                               TextAlignment="Right"/>

                    <Separator Width="1" Height="25"/>

                    <TextBlock VerticalAlignment="Center" FontWeight="SemiBold">
                        <Run Text="Slice: "/>
                        <Run Text="{Binding CurrentSliceIndex}"/>
                        <Run Text=" / "/>
                        <Run Text="{Binding TotalSlices}"/>
                    </TextBlock>
                </StackPanel>
            </Grid>
        </Grid>

        <!-- 하단 패널: 메타데이터 그리드 -->
        <Grid Grid.Row="2" Height="200">
            <DataGrid ItemsSource="{Binding DicomTags}"
                      IsReadOnly="True"
                      AutoGenerateColumns="False"
                      GridLinesVisibility="All">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Tag" Binding="{Binding Tag}" Width="150"/>
                    <DataGridTextColumn Header="VR" Binding="{Binding VR}" Width="80"/>
                    <DataGridTextColumn Header="Value" Binding="{Binding Value}" Width="*"/>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>
    </Grid>
</Window>
